# Transport applications {#transport}

## Prerequisites {-}

```{r, message=FALSE, results='hide'}
library(sf)
library(stplanr)
library(tidyverse)
```


In no other sector is geographic space more tangible than transport.
It is the effort of moving, particularly between places that are far apart, that led to the 'first law' of geography defined by Waldo Tobler in 1970 as follows [@miller_toblers_2004]: 

> Everything  is related  to  everything  else,  but  near  things  are more  related  than  distant  things

This 'law' applies to phenomena as diverse as friendship networks and ecological diversity and can be explained by the costs of transport --- in terms of time, energy and money.
These costs are known as the 'friction of distance'.
Thus transport technologies disrupt geographic relationships from the perspective of mobile humans and goods: "the purpose of transportation is to overcome space" [@rodrigue_geography_2013].

Transport is an inherently geospatial activity.
It involves traversing continuous geographic space between A and B, and infinite localities in between.
It is therefore unsurprising that transport researchers have long turned to geocomputational methods to understand movement patterns and that transport problems are a motivator of geocomputational methods.

This chapter provides an introduction to geographic analysis of transport systems.
We will explore how movement patterns can be understood at multiple geographic levels, including:

- Areal units: transport can be understood simply in terms of zonal aggregates such as the main mode and average distance of trips made people living in a particular zone.
- Nodes: these are points in the transport system that can represent common origins and destinations (e.g. with one centroid per zone) and public transport stations such as bus stops and rail stations.
- Desire lines: straight lines that represent 'origin-destination' data that records how many people travel (or could travel) between places (points or zones) in geographic space.
- Routes: these are cirquitous (non-straight) routes, typically representing the 'optimal' path along the route network between origins and destinations along the desire lines defined in the previous bullet point.
- Route networks: these represent the system of roads, paths and other linear features in an area. They can be represented as purely geographic entities or as a graph.
Their features are segments which can be assigned values representing 'flow', the number of people expected to use a particular street or path.
- Agents: these are the lowest-level but hardest to model entities in transport systems --- mobile entities like you and me.

These six levels of analysis show that transport systems are highly complex, even before accounting for the innevitable fact that all of them are constantly evolving in continuous time.
The purpose of geographic transport modelling can be interpretted as simplifying this complexity in a way that captures the essence of transport problems.

Typically models are designed to solve a particular problem.
For this reason this chapter is based around a policy scenario that asks:
how to increase walking and cycling?
We will use input data from Bristol, a coastal city in the West of England, described in the next section.

<!-- Idea: make it about reducing CO2 emissions instead. Thoughts? + Multi-model - more complex -->

## A case study of Bristol {#bris-case}

The case study used for this chapter is a diverse city on the west of England, 30 km east of the Welsh capital Cardiff.
As with any case study it is worth taking some time to consider the local geography of the area (see Figure \@ref(fig:bristol)).
This shows the diversity of the city's transport network, with railways, tarmac roads (consisting of 'roads' which bicycles can use and motorways which are exclusively for motor vehicles) and cycle paths plotted.

```{r, eval=FALSE, echo=FALSE}
library(osmdata)
bb = getbb("bristol uk")
ways_road = opq(bbox = bb) %>% 
  add_osm_feature(key = "highway", value = "motorway|cycle|primary|secondary", value_exact = FALSE) %>% 
  osmdata_sf()

ways_rail = opq(bbox = bb) %>% 
  add_osm_feature(key = "railway", value = "rail") %>% 
  osmdata_sf()

res = c(ways_road, ways_rail)

rail_stations = res$osm_points %>% 
  filter(railway == "station" | name == "Bristol Temple Meads")

# most important vars:
map_int(rail_stations, ~ sum(is.na(.))) %>% 
  sort() %>% 
  head()

rail_stations = rail_stations %>% select(name)
saveRDS(rail_stations, "extdata/rail_stations.Rds")

res$osm_lines$highway = as.character(res$osm_lines$highway)
res$osm_lines$highway[res$osm_lines$railway == "rail"] = "rail"
res$osm_lines$highway = gsub("_link", "", x = res$osm_lines$highway)
res$osm_lines$highway = gsub("primary|secondary", "road", x = res$osm_lines$highway)
ways_bristol = res$osm_lines %>% 
  select(highway, maxspeed, ref)
ways_bristol$highway = as.factor(ways_bristol$highway)
saveRDS(ways_bristol, "extdata/ways.Rds") # save for future reference
```

```{r bristol, echo=FALSE, fig.cap="Overview map of Bristol, with key parts of the transport network represented as colored lines for active (green), private motor (red lines and orange) and public (black) modes of travel.", message=FALSE}
# library(tmap)
# tmap_mode("view")
# qtm(ways, lines.col = "highway", lines.lwd = 3, lines.palette = c("green", "red", "black", "orange")) +
#   tm_scale_bar()
knitr::include_graphics("figures/bristol.png")
```

Bristol is the 10^th^ largest city council in England, with a population of half a million people in the city bounds (Bristol's travel catchment area is larger though, as demonstrated in the next section).
It has a vibrant economy with aerospace, media, financial service and tourism, alongside two major universities, contributing to a high average income per capita (although Bristol also has deprived, low income areas).

In terms of transport, Bristol is well served by rail and road links, and has a relatively high level of active travel.
19% of its citizens cycle and 88% walk at least once per month according to the [Active People Survey](https://www.gov.uk/government/statistical-data-sets/how-often-and-time-spent-walking-and-cycling-at-local-authority-level-cw010#table-cw0103) (the national average is 15% and 81% respectively).
8% of the population reported cycling to work in the 2011 census, compared with only 3% nationwide.

```{r, eval=FALSE, echo=FALSE}
if(!require(readODS)) {
  install.packages("readODS")
}
u = "https://www.gov.uk/government/uploads/system/uploads/attachment_data/file/536823/local-area-walking-and-cycling-in-england-2015.zip"
download.file(u, "local-area-walking-and-cycling-in-england-2015.zip")
unzip("local-area-walking-and-cycling-in-england-2015.zip")
View(readODS::read_ods("Table index.ods"))
cw0103 = readODS::read_ods("cw0103.ods")
View(cw0103)
```

Despite impressive walking and cycling statistics, the city has a major congestion problem.
Part of the solution is to continue increase the proportion of trips made by cycling.
Cycling has a greater potential to replace car trips than walking because of the speed of this mode, around 3-4 times faster than walking (with typical [speeds](https://en.wikipedia.org/wiki/Bicycle_performance) of 15-20 km/h vs 4-6 km/h for walking).
There is therefore a [plan](http://www.cyclingweekly.com/news/interview-bristols-mayor-george-ferguson-24114) to double the mode share of cycling by 2020.

In this policy context the aim of this chapter, beyond demonstrating how geocomputation with R can be used to support sustainable transport planning, is to provide evidence for decision-makers in Bristol to decide how best to increase the mode share of walking and cycling in particular in the city.
This high-level aim will be met via the following objectives:

- Describe the geographical pattern of transport behaviour in the city.
- Identify key nodes and potential bottlenecks where walking and cycling potential is likely to be highest.
- Analyse travel 'desire lines' in the city to identify those with greatest potential for modal shift.
- Building on the desire-line level analysis, identify which routes would most benefit from having dedicated cycleways and improved provision for pedestrians. 

To get the wheels rolling on the practical aspects of this chapter, we begin by loading zonal data on travel paterns.
These zone-level data are small but often vital for gaining a basic understanding of a settlement's overall transport system.

## Transport zones

Although transport systems are inherently based on linear features and nodes --- the nodes and edges of the transport network --- it often makes sense to start with areal data.
Three types of zone will typically be of particular interest: the study region, origin zones (typically residential areas), and destination zones (which are often the same as the origin zones).

The simplest definition of the study area is typically the first matching boundary returned by OpenStreetMap, which can be obtained using the **osmdata** package as follows:

```{r, eval=FALSE}
region = getbb("Bristol", format_out = "polygon")[1]
```

OSM will will often contain valid depiction of the case study city or region of interest (in this case the result is the same as the officially defined area of the Local Authority District).
However the approach is problematic because OSM data may not correspond to the most recent administrative areas over which transport planning authorities have control, meaning the analysis may be of limited interest to local transport planners.
More importantly, official administrative zones often do not relate to 'travel watersheds', areas that can are defined not by (often arbitrary) political decisions but by data on where people actually travel to.

To overcome this issue for transport data analysis in the UK, the Travel to Work Areas (TTWAs) were created.
TTWAs are contiguous zones defined roughly as areas in which 75% of the population both live and work.
Because Bristol is a major employer attracting travel from surrounding towns, its TTWA is substantially larger than its administratively defined area, as illustrated in Figure \@ref(fig:ttwa-bristol).

```{r, eval=FALSE, echo=FALSE}
# save region data + ttwa regions

# Note to RL: fix https://github.com/ropensci/osmdata/issues/104 - allowing this to be a 1 liner
region = getbb("Bristol", format_out = "polygon")[1] %>% 
  st_polygon() %>% 
  st_sfc() %>% 
  st_sf() %>% 
  st_crs(4326)
saveRDS(region, "extdata/bristol-region.Rds")
devtools::install_github("robinlovelace/ukboundaries")
library(ukboundaries)
# region_ttwa = ... wip
```

```{r ttwa-bristol, fig.cap="Region definitions in Bristol"}
region = readRDS("extdata/bristol-region.Rds")
plot(region)
```

## Nodes on the transport system

```{r}
rail_stations = readRDS("extdata/rail_stations.Rds")
```


## Desire line analysis

## Route analysis

## Route networks

The data used in this section was downloaded using **osmdata**.
To avoid having to request the data from OSM repeadetly, we'll use a locally saved version of the data, which contains point and line data for the case study area:

```{r}
ways = readRDS("extdata/ways.Rds")
summary(ways)
```

The above code chunk loaded a simple feature object representing around 3,000 segments on the transport network.
This an easily manageable dataset size (transport datasets be large but it's best to start small).

## Agents in the transport system
